services:
  client:
    image: ${AZCLI_CLEANROOM_CLUSTER_PROVIDER_CLIENT_IMAGE:-gsinhadev.azurecr.io/cleanroom-cluster/cleanroom-cluster-provider-client:latest}
    ports:
      - "0:8080"
    environment:
      - IDENTITY_ENDPOINT=http://credentials-proxy:8080/token
      - IMDS_ENDPOINT="dummy_required_value"
      - GITHUB_ACTIONS=${GITHUB_ACTIONS}
      - CODESPACES=${CODESPACES}
      - CREDENTIALS_PROXY_USER=${AZCLI_CLEANROOM_CLUSTER_UID}:${AZCLI_CLEANROOM_CLUSTER_GID}
      - CREDENTIALS_PROXY_HOST_AZURE_VOLUME=${HOME}/.azure
      - CR_CLUSTER_PROVIDER_PROXY_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_PROXY_IMAGE}
      - CR_CLUSTER_PROVIDER_ATTESTATION_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_ATTESTATION_IMAGE}
      - CR_CLUSTER_PROVIDER_OTEL_COLLECTOR_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_OTEL_COLLECTOR_IMAGE}
      - CR_CLUSTER_PROVIDER_GOVERNANCE_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_GOVERNANCE_IMAGE}
      - CR_CLUSTER_PROVIDER_SKR_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SKR_IMAGE}
      - CR_CLUSTER_PROVIDER_CONTAINER_REGISTRY_URL=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_CONTAINER_REGISTRY_URL}
      - CR_CLUSTER_PROVIDER_SIDECARS_POLICY_DOCUMENT_REGISTRY_URL=${AZCLI_CLEANROOM_SIDECARS_POLICY_DOCUMENT_REGISTRY_URL}
      - CR_CLUSTER_PROVIDER_CONTAINER_REGISTRY_USE_HTTP=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_CONTAINER_REGISTRY_USE_HTTP}
      - CR_CLUSTER_PROVIDER_SPARK_ANALYTICS_AGENT_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SPARK_ANALYTICS_AGENT_IMAGE}
      - CR_CLUSTER_PROVIDER_SPARK_ANALYTICS_AGENT_SECURITY_POLICY_DOCUMENT_URL=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SPARK_ANALYTICS_AGENT_SECURITY_POLICY_DOCUMENT_URL}
      - CR_CLUSTER_PROVIDER_SPARK_ANALYTICS_AGENT_CHART_URL=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SPARK_ANALYTICS_AGENT_CHART_URL}
      - CR_CLUSTER_PROVIDER_SPARK_FRONTEND_IMAGE=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SPARK_FRONTEND_IMAGE}
      - CR_CLUSTER_PROVIDER_SPARK_FRONTEND_SECURITY_POLICY_DOCUMENT_URL=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SPARK_FRONTEND_SECURITY_POLICY_DOCUMENT_URL}
      - CR_CLUSTER_PROVIDER_SPARK_FRONTEND_CHART_URL=${AZCLI_CLEANROOM_CLUSTER_PROVIDER_SPARK_FRONTEND_CHART_URL}
      - CR_CLUSTER_PROVIDER_CLEANROOM_SIDECARS_VERSIONS_DOCUMENT_URL=${AZCLI_CLEANROOM_SIDECARS_VERSIONS_DOCUMENT_URL}
      - CR_CLUSTER_PROVIDER_CLEANROOM_ANALYTICS_IMAGE_URL=${AZCLI_CLEANROOM_ANALYTICS_APP_IMAGE_URL}
      - CR_CLUSTER_PROVIDER_CLEANROOM_ANALYTICS_IMAGE_POLICY_DOCUMENT_URL=${AZCLI_CLEANROOM_ANALYTICS_APP_IMAGE_POLICY_DOCUMENT_URL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
    - credentials-proxy
  credentials-proxy:
    image: cleanroombuild.azurecr.io/workleap/azure-cli-credentials-proxy:1.2.5
    ports:
      - "0:8080"
    volumes:
      - ${HOME}/.azure:/app/.azure/
    user: "${AZCLI_CLEANROOM_CLUSTER_UID}:${AZCLI_CLEANROOM_CLUSTER_GID}"