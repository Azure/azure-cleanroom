services:
  client:
    image: ${AZCLI_CCF_PROVIDER_CLIENT_IMAGE:-mcr.microsoft.com/cleanroom/ccf/ccf-provider-client:1.0.12}
    ports:
      - "0:8080"
    environment:
      - WORKSPACE_DIR=/app/workspace
      - HOST_WORKSPACE_DIR=${AZCLI_CCF_PROVIDER_CLIENT_WORKSPACE_DIR}
      - IDENTITY_ENDPOINT=http://credentials-proxy:8080/token
      - IMDS_ENDPOINT="dummy_required_value"
      - GITHUB_ACTIONS=${GITHUB_ACTIONS}
      - CCF_PROVIDER_RUN_JS_APP_VIRTUAL_IMAGE=${AZCLI_CCF_PROVIDER_RUN_JS_APP_VIRTUAL_IMAGE}
      - CCF_PROVIDER_RUN_JS_APP_SNP_IMAGE=${AZCLI_CCF_PROVIDER_RUN_JS_APP_SNP_IMAGE}
      - CCF_PROVIDER_RECOVERY_AGENT_IMAGE=${AZCLI_CCF_PROVIDER_RECOVERY_AGENT_IMAGE}
      - CCF_PROVIDER_RECOVERY_SERVICE_IMAGE=${AZCLI_CCF_PROVIDER_RECOVERY_SERVICE_IMAGE}
      - CCF_PROVIDER_PROXY_IMAGE=${AZCLI_CCF_PROVIDER_PROXY_IMAGE}
      - CCF_PROVIDER_ATTESTATION_IMAGE=${AZCLI_CCF_PROVIDER_ATTESTATION_IMAGE}
      - CCF_PROVIDER_NGINX_IMAGE=${AZCLI_CCF_PROVIDER_NGINX_IMAGE}
      - CCF_PROVIDER_NETWORK_SECURITY_POLICY_DOCUMENT_URL=${AZCLI_CCF_PROVIDER_NETWORK_SECURITY_POLICY_DOCUMENT_URL}
      - CCF_PROVIDER_RECOVERY_SERVICE_SECURITY_POLICY_DOCUMENT_URL=${AZCLI_CCF_PROVIDER_RECOVERY_SERVICE_SECURITY_POLICY_DOCUMENT_URL}
      - CCF_PROVIDER_CONTAINER_REGISTRY_URL=${AZCLI_CCF_PROVIDER_CONTAINER_REGISTRY_URL}
      - CREDENTIALS_PROXY_USER=${AZCLI_CCF_PROVIDER_UID}:${AZCLI_CCF_PROVIDER_GID}
      - CREDENTIALS_PROXY_HOST_AZURE_VOLUME=/home/${USER}/.azure
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${AZCLI_CCF_PROVIDER_CLIENT_WORKSPACE_DIR:-.}:/app/workspace
    depends_on:
    - credentials-proxy
  credentials-proxy:
    image: cleanroombuild.azurecr.io/workleap/azure-cli-credentials-proxy:1.1.0
    ports:
      - "0:8080"
    volumes:
      - /home/${USER}/.azure:/app/.azure/
    user: "${AZCLI_CCF_PROVIDER_UID}:${AZCLI_CCF_PROVIDER_GID}"